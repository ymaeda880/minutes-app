# lib/prompts.py
# ------------------------------------------------------------
# 統一プロンプトレジストリ
# - 話者分離（Speaker Prep）
# - 議事録作成（Minutes Maker）
# ------------------------------------------------------------
from __future__ import annotations
from dataclasses import dataclass
from textwrap import dedent
from typing import List, Dict, Optional

# ===== カテゴリ識別子（ページ毎の名前空間） =====
SPEAKER_PREP = "speaker_prep"
MINUTES_MAKER = "minutes_maker"
MINUTES_STYLE = "minutes_style"  # 見た目スタイル用グループ


@dataclass(frozen=True)
class PromptPreset:
    key: str      # 内部キー
    label: str    # UI表示名
    body: str     # 追記本文


@dataclass(frozen=True)
class PromptGroup:
    group_key: str           # 例: SPEAKER_PREP / MINUTES_MAKER
    title: str               # UI/管理用タイトル
    mandatory_default: str   # 必須パート
    presets: List[PromptPreset]
    default_preset_key: str

    # ---- ユーティリティ（インスタンスメソッド） ----
    def preset_labels(self) -> List[str]:
        return [p.label for p in self.presets]

    def body_for_label(self, label: str) -> str:
        for p in self.presets:
            if p.label == label:
                return p.body
        return ""

    def label_for_key(self, key: str) -> str:
        for p in self.presets:
            if p.key == key:
                return p.label
        # fallback: 先頭のラベル
        return self.preset_labels()[0] if self.presets else ""


# ============================================================
#  話者分離（Speaker Prep）
# ============================================================
SPEAKER_MANDATORY = dedent("""
    あなたは日本語の会議文字起こしを整形する専門家です。
    以下の「生の文字起こしテキスト」を読み、話者を推定しながら発話ごとに改行して可読化してください。

    必須要件:
    1) 話者ラベルは S1:, S2:, S3: ... の形式
    2) 司会者は発言内容から特定し「司会者:」とする
    3) 文字は一字一句変えない

    注意:
    - 文字は変更しない・付け加えない
    - 会話の順序を維持
    - 話者ごとに改行し、さらに1行空ける
""").strip()

SPEAKER_PRESETS: List[PromptPreset] = [
    PromptPreset("none", "追記なし（基本のみ）", ""),
    PromptPreset(
        "strict_break",
        "文字起こしの誤りの指摘",
        dedent("""
            出力は以下の 2 部構成:
            【整形テキスト】…（S1:, S2: で始まる行で構成）
            【メモ】話者数の推定 / 主要トピック3点 / 用語ゆらぎの正規化例
            文字起こしの誤りと思われる箇所があれば列挙してください。
        """).strip()
    ),
    PromptPreset(
        "keep_ts",
        "タイムスタンプ保持",
        "入力に含まれる [hh:mm:ss] 等のタイムスタンプは削除せず各発話の先頭に残してください。"
    ),
    PromptPreset(
        "keep_noise",
        "原文完全保持（ノイズ・重複も残す）",
        "咳払い・えー/あー・（笑）なども削除せず、話者推定と改行のみ行ってください。"
    ),
    PromptPreset(
        "shrink_spaces",
        "空白縮約のみ",
        "文言や記号は変更せず、全角/半角スペースの連続のみ1つに縮約してください（句読点の前後は変更不可）。"
    ),
]

SPEAKER_GROUP = PromptGroup(
    group_key=SPEAKER_PREP,
    title="話者分離・整形",
    mandatory_default=SPEAKER_MANDATORY,
    presets=SPEAKER_PRESETS,
    default_preset_key="none",
)


# ============================================================
#  議事録作成（Minutes Maker）
# ============================================================

# ============================================================
#  Minutes Maker 全体共通の上位 mandatory
# ============================================================

MINUTES_GLOBAL_MANDATORY = dedent("""
    あなたは日本語の会議議事録（逐語録・簡易議事録・詳細議事録）を作成する専門家です。
    以下の入力テキスト（整形済みテキスト：話者ごとに分離されたテキスト）をもとに、
    指定されたモードに応じた形式の議事録を出力してください。

    【共通方針】
    - 事実関係を改変してはいけません。推測や補完を行う場合は、「〜と考えられる」「〜と思われる」など不確実性が分かる表現で示してください。
    - 日付・時刻・数値は、原則として半角で統一してください（例: 2025-12-08, 10:30, 3 件）。
    - 固有名詞（人名・地名・組織名・資料名など）は、入力テキスト中の表記をできるだけ尊重してください。
    - 同じ内容を繰り返し説明しないようにし、読み手が「何が議論され、何が決まり、次に何をするのか」を素早く把握できる構成を心がけてください。

    【書式・見た目に関する共通ルール】
    - 見出しには Markdown の見出し記法（#, ##, ###）を使用してください（行頭に全角スペースを入れない）。
    - 箇条書きは「- 」(半角ハイフン + 半角スペース) を用いてください。
    - Tab キーは使わず、インデントはすべて半角スペースで表現してください。
    - 行頭に「*」「●」「■」などの記号を用いた独自の箇条書きは使わないでください。
    - 不要な空行は避け、見出しやセクションの区切りの前後など、意味のある箇所だけに空行を入れてください。

    【箇条書きの構造（重要）】
    - 第1階層の箇条書きは、行頭に何も置かず「- 」で始めてください。
    - 第2階層の箇条書きは、行頭に半角スペース2個を入れてから「- 」で始めてください。
    - 第3階層の箇条書きは、行頭に半角スペース4個を入れてから「- 」で始めてください。
    - 箇条書き行の先頭に不要な全角スペースを入れないでください。
    - 段落は左揃えを基本とし、行頭インデントは付けないでください。
    - （推奨）第2階層までの入れ子構造は読みやすいため、必要に応じて積極的に使用してください。

    【表の出力に関する共通ルール（重要）】
    - 「変更指示一覧」「TODO 一覧」「決定事項一覧」など、表形式の出力が必要な場合は、
      必ず Markdown の表記法を用いて出力してください。
    - 表の構造は次の形式に従ってください（例）:

      | 列1 | 列2 | 列3 |
      | --- | --- | --- |
      | 値1 | 値2 | 値3 |

      ※この例は構造を示すだけであり、実際の列名・列数は指示に応じて変更して構いません。

    - 表に関する厳守事項:
      - 各行の先頭と末尾、および列の区切りには半角の縦棒 `|` を使ってください（全角「｜」は禁止）。
      - 2 行目は必ず `---` または `:---:` などの Markdown 規則に従った区切り行にしてください。
      - 行頭に余分な空白（特に全角スペース）を入れないでください。
      - コードブロック（``` で囲む形式）は使わないでください。表そのものだけを出力してください。
      - セル内で改行しないでください。複数文が必要な場合でも 1 セル内に 1 つの段落としてまとめてください。
      - セル内に `|` を含める必要がある場合は、必ず `\\|` とエスケープしてください。
      - 空欄セルが必要なときは完全な空文字ではなく、半角スペース 1 つを入れてください。

    - 「表形式だけを出力してください」「表のみを返してください」などと明示された場合は、
      上記の Markdown 表以外の文字（説明文・見出し・前置きなど）を書いてはいけません。
      ただし、議事録本文の中に必要に応じて表を挿入することはできます。

    これらの共通ルールは、逐語録・簡易議事録・詳細議事録のいずれのモードでも必ず守ってください。
""").strip()



# ------------------------------------------------------------
#  モード別 mandatory（モード固有部分のみ = RAW）
# ------------------------------------------------------------
MINUTES_MANDATORY_MODES_RAW: Dict[str, str] = {
    "逐語録": dedent("""
        あなたは日本語の会議逐語録を整える専門家です。
        以下の「整形済みテキスト」（話者ごとに分離されたテキスト）をもとに、
        元の発話内容をできるだけ忠実に残した「逐語録」を作成してください。

        要件:
        - 発言の順序は変えないこと。
        - 語句の変更は行わないこと．
                     
        出力フォーマット（見出し例）:
        # 会議概要
        - 会議名（分かる範囲で）
        - 主なテーマ
        - 日時・場所（分かる範囲で）
        - 参加者（役職や氏名が分かる範囲で）
                     
        # 逐語録:
        - 見出しやサマリーは付けず、シンプルな逐語録として出力してください。
        - 発言ごとの通し番号を「（0001）」などと見やすく振ってください。
        - 発言ごとに空白行を入れて見やすくしてください．
    """).strip(),

    "簡易議事録": dedent("""
        あなたは日本語の会議議事録を作成する専門家です。
        以下の「整形済みテキスト」（話者ごとに分離されたテキスト）をもとに、
        会議の要点を押さえた「簡易議事録」を作成してください。

        基本方針:
        - 発言内容をそのまま書き写すのではなく、論点・意見・確認事項・決定事項を整理してまとめてください。
        - 脱線した雑談や細かな言い回しは省略して構いません。
        - あとから参加者が読み返したときに「どのような議論があり、何が決まったか」が把握できるレベルを目指します。
        - 全体として A4 1〜2枚程度のボリューム感に収まる密度で要約してください。

        出力フォーマット（見出し例）:
        # 会議概要
        - 会議名（分かる範囲で）
        - 主なテーマ
        - 日時・場所（分かる範囲で）
        - 参加者（役職や氏名が分かる範囲で）

        # 議論の概要
        - 議論された主なトピックを箇条書きで整理（1トピックあたり1〜3行）

        # 決定事項
        - 箇条書きで簡潔に記述（1行で要約）
        - 必要に応じて背景を1文だけ補足してもよい

        # TODO
        - [担当: 氏名または部署, 期限: 分かる範囲で] 作業内容
        - 期限や担当が不明な場合は「担当・期限: 未確定」と明記

        # メモ・補足（任意）
        - 今後の検討事項や、論点として残しておくべき内容があれば簡潔に記載

        制約:
        - 事実の改変は禁止（推測が入るときは「〜と考えられる」「〜と思われる」といった表現を用いる）。
        - 日付・時刻・数量は半角で統一してください。
        - 固有名詞はできるだけ元の表記を維持してください。
    """).strip(),

    "詳細議事録": dedent("""
        あなたは会議の議事録作成の専門家です。与えられた整形済みテキストから、
        重要事項、決定事項、TODO（担当者・期限）、論点、論拠、未解決事項を正確に抽出し、
        わかりやすく構造化した日本語の詳細議事録を作成してください。

        出力フォーマット（見出しはこの順序・文言で出力）:
        # サマリー（3〜5行）
        # 決定事項
        - 箇条書き（番号付き）。各項目に背景/根拠を1文で添付。
        # TODO（担当・期限つき）
        - 例）[担当: 氏名, 期限: YYYY-MM-DD] 具体的な作業内容
        # 重要トピック（最大5つ）
        - 各トピックの論点と結論を短く
        # 補足・論拠
        - 参照すべき資料・データがあれば列挙
        # 未解決事項・次回アジェンダ

        制約:
        - 事実の改変は禁止（聞き違いの推測は「不確実」と明記）。
        - 日付・数量は半角、固有名詞は元の表記を維持。
        - 箇条書きは簡潔、1行80字程度を目安に適宜改行。
        - 必要に応じて、重要な発言については「誰が・何を主張したか」が分かるように要約してください。
    """).strip(),
}

# ------------------------------------------------------------
#  上位 mandatory を前置した「本番用」モード辞書
# ------------------------------------------------------------
MINUTES_MANDATORY_MODES: Dict[str, str] = {
    mode: (MINUTES_GLOBAL_MANDATORY + "\n\n" + body)
    for mode, body in MINUTES_MANDATORY_MODES_RAW.items()
}

# デフォルトは「簡易議事録」
MINUTES_MANDATORY = MINUTES_MANDATORY_MODES["簡易議事録"]


MINUTES_PRESETS: List[PromptPreset] = [
    PromptPreset(
        "with_summary_points",
        "サマリを箇条書きで厳密化",
        dedent("""
            サマリーは必ず5行以内とし、文頭に「・」を付けた箇条書き形式で、
            会議の目的・結論・重要な決定事項が一目で分かるように簡潔に要約してください。
        """).strip()
    ),
    PromptPreset(
        "add_risks",
        "リスク/懸念の抽出を追加",
        dedent("""
            # リスク・懸念
            - コスト、スケジュール、品質、セキュリティ、法務の観点で潜在的リスクを抽出してください。
            - 各リスクについて「発生確率（低/中/高）」と「影響度（低/中/高）」をタグとして付与してください。
        """).strip()
    ),
    PromptPreset(
        "exec_brief",
        "経営向けブリーフ（A4半頁）",
        dedent("""
            経営層向けにA4半頁相当のブリーフも併記してください。
            見出し: 「エグゼクティブ・ブリーフ」
            内容: 目的 / 現状 / 意思決定事項 / 次アクションを3〜6行で簡潔にまとめてください。
        """).strip()
    ),
    PromptPreset(
        "inline_timecodes",
        "元テキストのタイムコード参照付き",
        dedent("""
            元テキストに [hh:mm:ss] 等のタイムコードが含まれている場合、
            可能な範囲で関連する項目の末尾に括弧付きで付与してください（例: （参照: 00:12:34））。
        """).strip()
    ),
]

MINUTES_GROUP = PromptGroup(
    group_key=MINUTES_MAKER,
    title="議事録作成",
    mandatory_default=MINUTES_MANDATORY,
    presets=MINUTES_PRESETS,
    default_preset_key="none",
)


# ============================================================
#  見た目スタイル（UI 用だが将来 GPT 指示にも使えるよう枠だけ残す）
# ============================================================

MINUTES_STYLE_MANDATORY = dedent("""
    このカテゴリは議事録の「見た目」に関する設定です。
    現状では GPT への指示内容には含めませんが、
    将来的に見た目スタイルを GPT 出力へ反映させる場合に使用します。
""").strip()

# GPT への影響はしないが、プリセット構造は残す
MINUTES_STYLE_PRESETS: List[PromptPreset] = [
    PromptPreset(
        key="style_horizontal_lines",
        label="見た目1：横線あり",
        body=""      # ← 現状は GPT へ送らないので空でOK
    ),
    PromptPreset(
        key="style_no_lines",
        label="見た目2：横線なし",
        body=""      # ← 現状は GPT へ送らないので空でOK
    ),
]

MINUTES_STYLE_GROUP = PromptGroup(
    group_key=MINUTES_STYLE,
    title="議事録見た目スタイル（UI用途・拡張枠）",
    mandatory_default=MINUTES_STYLE_MANDATORY,
    presets=MINUTES_STYLE_PRESETS,
    default_preset_key="style_horizontal_lines",
)

# ============================================================
#  レジストリ（ページ横断で参照）
# ============================================================
_REGISTRY: Dict[str, PromptGroup] = {
    SPEAKER_PREP: SPEAKER_GROUP,
    MINUTES_MAKER: MINUTES_GROUP,
    MINUTES_STYLE: MINUTES_STYLE_GROUP,
}


def get_group(group_key: str) -> PromptGroup:
    if group_key not in _REGISTRY:
        raise KeyError(f"Unknown prompt group: {group_key}")
    return _REGISTRY[group_key]


def build_prompt(mandatory: str, preset_body: str, extra: str, src_text: str) -> str:
    """実際にモデルへ渡すプロンプトを組み立て（共通関数）"""
    parts = [mandatory.strip()]
    if preset_body and preset_body.strip():
        parts.append(preset_body.strip())
    if extra and extra.strip():
        parts.append("【追加指示】\n" + extra.strip())
    parts.append("【入力テキスト】\n" + src_text)
    return "\n\n".join(parts)
